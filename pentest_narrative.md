## Internal Network Penetration Test
# Discovery

Prior to commencing with the assessment, the assessor confirmed the testing scope with the client and the goals of the assessment. The assessor initiated the assessment by connecting to the client’s internal network via the TKTK how?. The TKTK connection provided the assessor direct access to VLAN TKTK on the local network.

# Enumeration & Vulnerability Mapping

The assessor initiatetd the examination by identifying the network information provided in the DHCP lease, which was automatically obtained after connecting to the network. This information is found in the `/etc/resolv.conf` file and includes DNS information, which is typically associated with Active Directory (AD) domains. This file listed `TKTK` as the search domain with TKTK DNS servers, as shown below.

~~~
cat /etc/resolv.conf
~~~

Next, the assessor started `responder`, a tool to listen for vulnerable broadcast traffic. This tool sends spoofed responses to a variety of vulnerable traffic such as Link Local Multicast Name Resolution (LLMNR) and NetBIOS Name Resolution (NBT-NS) in an attempt to coerce other devices and users into authenticating to our attacking computer and provide credential material such as password hashes for offline cracking or relaying to other machines. The assessor noticed [>> TKTK a large amount of broadcast LLMNR and NBT-NS traffic vulnerable to this spoofing attack.]

~~~
responder -I eth0 -wrfFPb
 
[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    DNS/MDNS                   [ON]
 
[+] Servers:
    HTTP server                [ON]
    HTTPS server               [ON] 
    WPAD proxy                 [ON]
    Auth proxy                 [OFF]
    SMB server                 [ON]
    Kerberos server            [ON]
    SQL server                 [ON]  
    FTP server                 [ON]  
    IMAP server                [ON] 
    POP3 server                [ON]
    SMTP server                [ON]
    DNS server                 [ON] 
    LDAP server                [ON]
    RDP server                 [ON]
 
[+] Poisoning Options:
    Analyze Mode               [OFF]
    Force WPAD auth            [ON]
    Force Basic Auth           [ON]
    Force LM downgrade         [OFF]
    Fingerprint hosts          [ON]

[+] Generic Options: TKTK:
    Responder NIC              []
    Responder IP               []
    Challenge set              []
    Don't Respond To Names     ['TKTK']

[+] Listening for events...
~~~

[>> TKTK unverified, check this] In addition to LLMNR and NBT-NS poisoning to coerce authentication, the assessor used the `mitm6` tool to perform IPv6 network poisoning. Windows releases since Vista prefer IPv6 by default and send out DHCPv6 broadcast requests to obtain IPv6 configuration information. As most internal networks use IPv4, `mitm6` exploits this behavior by sending a response to these requests with the attacking machine configured as a DNS server. When successful, this attack grants the attacker control of the victim's DNS, allowing authentication attacks similar to `responder`. [>> TKTK did it work??]

~~~
mitm6 -d tktk.domain
ntlmrelayx.py -6 -wh pscfirst.tktk.domain -tf hosts-no-signing.lst -l loot/ -debug
~~~

The assessor began to gather information using the `nmap` tool to scan networks to identify live hosts and their listening services. `nmap` is a port scanning tool that checks for listening services and probes them for information such as banners, version information, and even common vulnerabilities. The assessor reviewed the scan output for common vulnerabilities and attack vectors.

~~~
nmap -iL corp.lst -sVC --open -oA scans/nmap-default-sVC --min-hostgroup=128 --max-retries=1 -v
~~~

The assessor also performed an `nmap` scan of the cardholder data environment to reveal any direct connectivity accessible from the corporate network. This scan identified [>> TKTK four ports open on `TKTK` including SMB on TCP/445, a protocol that can be used for remote administration. Furthermore, the scan identified one additional port on .]

~~~
nmap -iL cde.lst -p- -v -sVC -oA scans/nmap-cde-sVC-allports  # smal cde
nmap -iL cde.lst -v -sVC -p21,22,23,25,53,80,111,121,135,139,443,445,1433,1521,2049,3306,3389,4786,5945,5985,8080,8443,9090,9443,9875,2093,49152,902,5900,2000,389,636,8000,10943 -oA scans/nmap-cde-sVC-top32     #big cde
~~~

With `responder` and `nmap` running in the background, the tester leveraged the `masscan` tool to scan for hosts with services such as SMB (TCP/445), RDP (TCP/3389), SSH (TCP/22), and MSSQL (TCP/1433) listening. This tool uses asynchronous transmissions withh a custom network stack to rapidly scan targets. The output of this tool provided a list of hosts for use in vulnerability scans.

~~~
masscan -iL corp.lst -p445 -oG scans/masscan-corp-445.gnmap
grep open scans/masscan-corp-445.gnmap | wc -l

masscan -iL corp.lst -p3389 -oG scans/masscan-corp-3389.gnmap
grep open scans/masscan-corp-3389.gnmap | wc -l

masscan -iL corp.lst -p22 -oG scans/masscan-corp-22.gnmap
grep -c open scans/masscan-corp-22.gnmap 

masscan -iL corp.lst -p1433 -oG scans/masscan-corp-1433.gnmap                        
grep open scans/masscan-corp-1433.gnmap | wc -l
~~~

With a list of hosts with TCP/445 open, the assessor began probing this service for more information. This port is typically used for the Server Message Block (SMB) service, used for file sharing and remote management. The assessor use Metasploit's `smb_version` module to determine the operating system version of these hosts and the SMB signing requirements. SMB signing is a security mechanism Microsoft implemented that attempts to mitigate the effects of man-in-the-middle attacks. [>> TKTK outdated systems. no smb signing requirement.]

~~~
msfconsole -q
use auxiliary/scanner/smb/smb_version
set rhosts file:scans/masscan-corp-445.lst
run
~~~

Below is a table of identified operating systems:

<table border="0" rules="none" frame="void">
  <tbody>
    <tr><td>**Windows OS Version**</td>
      <td>**Currently Supported?**</td>
      <td>**Count of this OS**</td>
    </tr>
  </tbody>
</table>

The assessor then scanned these systems for the EternalBlue vulnerability (MS17-010). This vulnerability is a critical flaw in the SMBv1 protocol that can grantt an attacker anonoymous remote code execution (RCE) on the system as the  `NT AUTHORITY\SYSTEM` account. This scan identified TKTK vulnerable systems.

~~~
use auxiliary/scanner/smb/smb_ms17_010
set rhosts file:scans/masscan-corp-445.lst
run
~~~

Next, the assessor used the list of remote desktop (RDP) services for "BlueKeep," a critical vulnerability (CVE-2019-0708), with the Metasploit scanning module. This issue can lead to remote code execution as the local `SYSTEM` user; however, the exploit is only stable for Windows 7. [>> TKTK As a result, the assessor did not pursue exploitation of these systems during the penetration test. OR ]

~~~
use auxiliary/scanner/rdp/cve_2019_0708_bluekeep
set RHOSTS fille:scans/masscan-corp-3389.lst
run
~~~

With servers running MS-SQL on port TCP/1433, the assessor checked for weak or default credentials. MS-SQL is a Microsoft database management software that is commonly used by organizations that leverage Active Directory. In some instances, weak or default credentials on MS-SQL server instances can lead to code execution or credential theft. The assessor used Metasploit to test for common credentials with the `mssql_login` module [>> TKTK but did not identify any that were valid on these systems.]

~~~
use auxiliary/scanner/mssql/mssql_login
set RHOSTS file:scans/masscan-corp-1433.lst
set BLANK_PASSWORDS true
set PASSWORD sa
run
### check other ports too...try nessus output
~~~

After reviewing completed port scan results, the assessor noticed several PostgreSQL database servers listening on TCP/5432. In certain versions of this software, successful authentication to this service can lead to code execution. To test for weak or default credentials, he used the `postgres_login` module from the Metasploit [>> TKTK but did not identify any that were valid on these systems.]

~~~
use auxiliary/scanner/postgres/postgres_login
set RHOSTS file:scans/masscan-corp-5432.lst
set BLANKPASSWORDS true
run
### check the USERPASS_FILE options
~~~

Network scanning activities revealed TKTK systems allowing anonymous access to FTP servers. Most of these services were for printers, and did not grant access to sensitive data.

~~~

~~~

Next, the tester generated a list of hosts in the target environment and proceeded to check for weak SNMP community strings. The Simple Network Management Protocol (SNMP) is a UDP-based protocol used to gather information from the environment. 

The assessor used the `onesixtyone` tool to test for weak or common community strings. This tool attempts to query information using a list of community strings and identified 12 systems with common community strings such as `public` or `private`.

~~~
> onesixtyone
~~~

Next, the assessor tested Active Directory (AD) domain controllers (DCs) for the allowance of null sessions. A null session allows domain queries without requiring authentication credentials. The information that can be gathered from the domain can be quite useful to an attacker to build attacks and/or escalate privileges. The assessor first used the `ping` utility to identify a DC by pinging the `TKTK.com` domain found via DHCP, and then the `rpcclient` tool to test for null sessions to develop a list of domain accounts for use in password attacks. The assessor was able to query information without authentication, indicating the server allows null sessions.

~~~
> ping corp.tktk.com -c 2

> rpcclient -U '%' tktk.corp.tktk.com
~~~

With a list of domain controllers, the tester proceeded to check for the "ZeroLogon" vulnerability (CVE-2020-1472). This NETLOGON vulnerability allows for escalation to domain administrator privileges. The assessor determined that the DCs were patched to prevent abuse of this vulnerability.

~~~
https://github.com/michaelpoznecki/zerologon
~~~

The assessor then used a technique that would allow enumeration of valid usernames on the [>> TKTK DOMAIN] domain. Using a listing of [statistically likely usernames](https://github.com/insidetrust/statistically-likely-usernames), the assessor constructed a list of users to test with the `KrbGuess` tool. This tool takes advantage of a feature of the Kerberos v5 authentication protocol that provides different responses for existing and non-existing users when requesting Kerberos tickets. The tool accepts a list of potential users and determines which are valid by initiating a ticket request for each user and analyzing the error message received.

~~~
> KrbGuess
~~~

Next, the assessor used a tool named `aquatone` to gather screenshots of web applications. This allowed the assessor to observe web applications without manually connecting to each one. This tool scans hosts for ports that are typically used to host web sites. Vulnerable web services can often be used to gain a foothold or further access on the network. The assessor reviewed the web application screenshots to identify sites and applications of interest.

~~~
mkdir -p enum/aquatone/
cat hosts.lst | /opt/aquatone/aquatone -out enum/aquatone/ -ports 80,81,280,300,443,591,593,623,664,777,808,832,981,1010,1183,1184,1311,2082,2087,2095,2381,2480,3000,3128,3333,4035,4036,4243,4443,4567,4711,4848,4993,5000,5104,5108,5554,5800,5801,5802,5803,5988,5989,6543,6788,7000,7004,7072,7396,7443,7474,7627,8000,8001,8008,8080,8014,8042,8069,8081,8088,8090,8091,8118,8123,8172,8222,8243,8280,8281,8333,8443,8444,8445,8500,8765,8834,8880,8888,8983,9000,9043,9060,9090,9091,9200,9443,9800
~~~

After analyzing the `aquatone` output, the assessor identified several potential attack vectors. TKTK web servers provided access to an Apache Tomcat Manager [>> or Jenkins] web interface. This service is commonly configured with weak or default credentials. During installation, the server is often set up with well-known credentials that have been publicly documented. The assessor made attempts to determine valid credentials for the service using the `tomcat_mgr_login` module of the Metasploit framework [>> TKTK but did not recover any valid passwords.]

~~~
msf5 > use auxiliary/scanner/http/tomcat_mgr_login 
msf5 auxiliary(scanner/http/tomcat_mgr_login) > set rhosts file:enum/tomcat_8080.lst
msf5 auxiliary(scanner/http/tomcat_mgr_login) > run
~~~

[>> TKTK other web services as applicable]

After performing manual discovery and vulnerability analysis, the tester configured the Nessus scanner to perform automated discovery and vulnerability scanning on the target corporate network. Nessus is able to perform additional checks such as analyzing banner information against databases of known vulnerabilities and perform automated application testing across a large number of web servers. The assessor identified additional vulnerabilities [>> TKTK such as ].

# Exploitation

After analyzing the information from the discovery and vulnerability analysis stage, the assessor moved to the exploitation phase. Valid usernames gathered from Kerberos guessing were then subjected to password-guessing attacks using a module from the Metasploit tool, `smb_login`. This module tests logins to an SMB service to determine if credentials are valid and if the tested account has administrator-level access. Password attacks consisted of the list of valid usernames with commonly-used passwords, using words related to seasons, dates, and variations of the client’s company name. This attack compromised TKTK accounts. [>> This attack compromised did not succeed and no passwords were recovered.]

~~~
use auxiliary/scanner/smb/smb_login
set ABORT_ON_LOCKOUT true
set RHOSTS dc
set SMBDomain BADDOMAIN
set USER_FILE BADDOMAIN-users.lst
set BRUTEFORCE_SPEED 2     # needed for fiserv where they rate limi
set SMBPASS Welcome2021!
run
~~~

With SMB signing not enforced across the network and LLMNR/NBNS broadcast traffic identified on the local network, the assessor attempted an NTLM relay attack with the Impacket tool `ntlmrelayx.py`. This tool performs a relay attack and, by default, attempts to dump the SAM database of the target systems. As shown below, the assessor received a connection from `tktk` for the user `CORP\user`. The tool automatically relayed an authentication attempt to `smb://172.28.15.79`. While this authentication relay succeeded, the SAM dump attempt failed as accounts must have local administrator privileges to perform privileged actions such as dumping the SAM database. After multiple similar failed attempts to dump credentials for target machines, an SMB relay to the machine `10.1.15.49` succeeded and revealed the NT hashes for the local accounts on this machine. Other users' authentication attempts were captured and used for relay; however, none had sufficient privileges to extract SAM database credentials.

~~~
> python3 /usr/share/doc/python3-impacket/examples/ntlmrelayx.py -tf hosts-smb-signing-optional.lst -of loot/ntlmrelayx-hashes -wh pscfirst -ts
Impacket v0.9.20 - Copyright 2019 SecureAuth Corporation

[*] Protocol Client SMB loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client SMTP loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client LDAP loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server

[*] Setting up HTTP Server
~~~

With several hashes retrieved from network NTLM authentication attempts and local SAM database, the assessor attempted to crack the hashes offline using John the Ripper locally on the attacking machine. The assessor noted that the network authentication protocol in use is Net-NTLMv1, an insecure legacy protocol replaced by Net-NTLMv2 (Note: Although Net-NTLMv1 was replaced by Net-NTLMv2, Kerberos is the recommended protocol for network authentication). Several Net-NTLMv1 hashes were cracked, and one NT hash was cracked; however, the hash for the `smfpc` user was empty.

~~~
awk -F: '!seen[$1]++' /usr/share/responder/logs/*.txt     # dedupes and keeps just 1 for each user
> john ntlmrelayx-hashes_ntlm.deduped --wordlist=/usr/share/wordlists/rockyou.txt --rules
~~~

Also, the assessor leveraged a GPU-based cracking system to recover passwords for additional accounts. This custom-built system uses the power of GPUs combined with dictionaries to hash character combinations or entries from word lists and compare them to the captured hashes. A matching hash determines the plaintext version of the password, ”cracking” the password and compromising the account. One additional NT hash for the user `tktk` was cracked and recovered in plaintext.

Next, the assessor proceeded to exploit the machines vulnerable to MS17-010. Given the legacy target operating systems, the assessor used the `ms17_010_psexec` exploit module in Metasploit. This module uploads a service executable that executes a payload on the target machine, establishing a meterpreter command and control (C2) session. This version of the exploit requires access to a named pipe to work. Since two of the three machines did not have named pipes accessible, the exploit failed on these hosts. It should be noted that with additional effort, an exploit could be weaponized for these machines[^eternalblueembedded]. As demonstrated below, the assessor was able to successfully execute the exploit the vulnerability and establish a meterpreter session on the target system.

~~~
msf5 exploit(windows/smb/ms17_010_psexec) > run
~~~

With a meterpreter session established, the assessor began information gathering and credential harvesting on the target machine. First, the assessor used the `hashdump` utility, which extracts credentials from the SAM database. This revealed the password hashes for the local users on the system, which included the legacy LM hashes. LM hashes are considered weak and can typically be cracked in a very short period of time.

~~~
meterpreter > hashdump 
~~~

# Post-Exploitation

With valid cleartext and [>> hashed] credential material, the assessor proceeded to the post-exploitation phase of the penetration test involving the identification of lateral movement within the network and privilege escalation in an attempt to access CDE resources. The assessor reviewed network shares accessible over SMB, as these often contain files with credential material. Logon scripts may contain cleartext credentials and certain XML can contain encrypted versions of passwords. After conducting an in-depth review of these shares, the tester did not discover any credentials stored within files. [>> PSC conducted an in-depth review of these shares and discovered [>> TKTK how many? What did they get you access to?] credentials stored within files.]

~~~
> plunder
~~~

The assessor then attempted to gather service principal names (SPNs) from a domain controller. Service principal names are unique identifiers used by Kerberos authentication to associate service instances with service logon accounts. These SPNs can be leveraged to gather hashes that can be subjected to cracking attacks, which may reveal plaintext versions of passwords. This attack is called Kerberoasting. As service accounts are typically configured to have administrative credentials on multiple systems, and in some cases configured with domain administrator credentials, this attack can lead to privilege escalation on the network. The assessor used Impacket’s `GetUserSPNs.py` to retrieve these hashes.

~~~
> GetUserSPNs.py -dc-ip 10.200.100.10 corp.tktk.com/tktk
~~~

Similar to the Kerberoast attack, the assessor next attempted to identify users that didn't require Kerberos pre-authorization. If an AD account is configured with `DONT_REQ_PREAUTH`, an `AS-REQ` ticket request will return an `AS-REP` reply that contains information encrypted with the client secret (the users NT password hash). This information can be leveraged in offline password-cracking attacks to recover the user's AD password. However, no users were configured with `DONT_REQ_PREAUTH` and this attack did not recover any password hashes.

~~~
GetNPUsers.py tktk.com/user:password -request -outputfile loot/as-reps.hsh
~~~

With the hashes for tktk accounts retrieved, the assessor leveraged the GPU-powered password cracking tool Hashcat to recover hashes for these accounts. In all, four hashes were cracked within seconds, including the `corp\blah` account. This account is a member of the Domain Admins group and provided a trivial method to escalate privileges on the domain from any domain user.

To identify access across the network with the compromised credentials, the assessor used the CredNinja tool, which takes a list of usernames and passwords as well as a list of networks to check. The tool then scans the networks for the SMB service and attempts to log into the identified services as well as checks for local administrative privileges. As a result of this check, three accounts had local administrator access on 146 systems. One account, `TKTK`, was a RID500 local administrator account on TKTK systems. A local administrator account with the same password configured on multiple systems can lead to trivial lateral movement scenarios.

~~~
> /opt/credninja.py -a loot/cleartext.lst -s corp.lst --valid --scan -o loot/credninja-cleartext-1.out 
~~~

With an established foothold on the `DOM` domain, the assessor gathered LDAP information with a Python-based version of the BloodHound tool, `bloodhound-python`. BloodHound is a set of tools that query LDAP information from an Active Directory domain controller and processes the information offline to visualize attack paths through insecure user group membership, vulnerable Active Directory configurations, or abusable access control entries (ACEs) configured on compromised AD objects.

~~~
> bloodhound-python -c all -d corp.xxxxx.com -u user -p pass
~~~

This tool ingests session information to identify users logged into Windows systems in the domain to identify highly-privileged accounts logged into workstations or servers across the domain. The tester identified one computer, `computer`, with a session of a domain admin `DA`. This account was configured with the `user` local admin account, granting the assessor full control of the machine.

TKTK Unconstrained/constrained delegation

TKTK CredSniper.ps1 to look at secrets in email history, etc.

The assessor leveraged this TKTK elevated access to extract the hashes from the target system [>> TKTK using the `hashdump` meterpreter functionality OR using the `secretsdump.py` script based on the Impacket framework OR by saving the SAM and SECURITY registry hives, transferring the files to the attacker machine, and processing them offline]. This revealed the local administrator password for the target system.

The assessor attempted to identify authentication tokens on hosts. These tokens can be impersonated to access domain resources under the context of the impersonated account. Using the token of a domain administrator allows the ability to interact with the domain controller with a domain administrator level of control. The assessor identified such a token on a compromised system and impersonated it in an attempt to add a user to the domain and to add this user to the Domain Admins group. However, both attempts failed. [>> This succeeded, granting the assessor full control of a domain admin account.]

With this level of access, the assessor used the `secretsdump.py` tool from Impacket to extract domain credentials from the `NTDS.dit` file from a domain controller. This demonstrate a full compromise of the `CORP.TKTK.COM` domain.

~~~
> secretsdump.py corp.TKTK.com/TKTK@corp.tktk.com -outputfile loot/ntds_dumps/tktk.com
~~~

After the assessor was able to obtain access to the cardholder data environment, the execution window for the penetration test ended, and the assessor completed testing. In all, the assessor was able to gain a foothold on `CORP.TKTK.COM`, escalate privileges on the domain, compromise the `CDE.TKTK.COM` domain, and leverage this access to pivot into the CDE network.

Try to pivot to restricted network: https://github.com/deletehead/the_hax/blob/master/internal_methodology.md#lateral-movement-to-restricted-segment

{::break page /}

During the course of our examination the following accounts were exposed and the passwords obtained in clear text:

* `DOMAIN\user1`

These accounts should be considered compromised and all passwords changed.
